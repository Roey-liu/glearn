Linux内核对多队列的支持

多队列对应的结构：Linux的网卡由结构体net_device表示，一个该结构可以对应多个可以调度的数据包发送队列，数据包的实体在内核中以结构体sk_buff（skb）表示

接收端：网卡驱动程序为每个接收队列设定相应的中断号，通过中断的均衡处理，或者设置中断的亲和性，从而实现队列绑定到不同的核。

发送端：Linux提供了较为灵活的队列选择机制。dev_pick_tx用于选取发送队列，他可以是driver定制的策略，也可以根据队列优先级选取，按照hash做均衡。将队列分配给某个或某几个CPU处理，这样就可以减少锁竞争。

收发队列一般会被绑在同一个中断上。如果从收队列1收上来的包从发队列1发出去，cache命中率高，效率也会高。

对于单队列的网卡设备，就需要用软件来均衡流量。

DPDK与多队列

DPDK提供了一系列以太设备的API，其Packt I/O机制具有与生俱来的多队列支持功能，可以根据不同的平台或者需求，选择需要使用的队列数目，并可以很方便地使用队列，指定队列发送或接收报文。

DPDK的队列管理机制还可以避免多核处理器中的多个收发进程采用自旋锁产生的不必要的等待。

以run to completion模型为例，可以从核、内存与网卡队列之间的关系来理解DPDK是如何利用网卡多队列技术带来性能的提升。

将网卡的某个接收队列分配给某个核，从该队列中收到的所有报文都应当在该指定的核上处理结束

从核对应的本地存储中分配内存池，接收报文和对应的描述符都位于该内存池

为每个核分配一个单独的发送队列，发送报文和对应的报文描述符都位于该核和发送队列对应的本地内存池中。

网卡驱动
对每个流生成一个hash标识， 这个hash值可以通过四元组（ 源IP地址
SIP， 源四层端口SPORT， 目的IP地址DIP， 目的四层端口DPORT） 来
计算， 然后由中断处理的地方根据这个hash标识分配到相应的core

# 流分类

流分类， 指的是网卡依据数据包的特性将其分类的技
术。 

RSS
这里要介绍一种网卡上用于将流量分散到不同的队列中的技术： RSS（Receive-Side Scaling， 接
收方扩展） ， 

简单的说， RSS就是根据关键字通过哈希函数计算出哈希值， 再由
哈希值确定队列。 

从这个过程我们可以看出， RSS是否能将数据包均匀地散列在多个
队列中， 取决于真实环境中的数据包构成和哈希函数的选取

Flow Derector

由Intel公司提出的根据包的字段精确匹配，将其分配到某个特定队列的技术