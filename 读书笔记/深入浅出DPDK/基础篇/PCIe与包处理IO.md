## PCIe

<div align="center"> <img src="pic/PCIe.png"/> </div>

一般网卡采用DMA控制器通过PCIe Bus访问内存， 除了对以太网数据内
容的读写外， 还有DMA描述符操作相关的读写， 这些操作也由
MRd/MWr来完成

## 网卡DMA描述符环形队列

DMA（Direct Memory Access， 直接存储器访问） 是一种高速的数
据传输方式， 允许在外部设备和存储器之间直接读写数据。 数据既不通
过CPU， 也不需要CPU干预。 整个数据传输操作在DMA控制器的控制
下进行。 


网卡DMA控制器通过环形队列与CPU交互。

环形队列由一组控制寄存器和一块物理上连续的缓存构成。 

主要的控制寄存器有Base、
Size、 Head和Tail。 通过设置Base寄存器， 可以将分配的一段物理连续
的内存地址作为环形队列的起始地址， 通告给DMA控制器。 同样通过
Size寄存器， 可以通告该内存块的大小。 Head寄存器往往对软件只读，
它表示硬件当前访问的描述符单元。 而Tail寄存器则由软件来填写更
新， 通知DMA控制器当前已准备好被硬件访问的描述符单元。


无论进行收包还是发包， 网卡驱动软件需要完成最基本的操作包
括， 1） 填充缓冲区地址到描述符； 2） 移动尾指针； 3） 判断描述符中
的完成状态位。 


DMA操作可以利用Intel®处理器的Direct Data
IO（DDIO） 技术， 从而减少对内存的访问。 

DMA控制器通过一组描述符环行队列与CPU互操作完成包的收
发。 环形队列的内容部分位于主存中， 控制部分通过访问外设寄存器的
方式完成

## 全景转发操作交互示意
接收方向：
1） CPU填充缓冲地址到接收侧描述符。
2） 网卡读取接收侧描述符获取缓冲区地址。
3） 网卡将包的内容写到缓冲区地址处。
4） 网卡回写接收侧描述符更新状态（确认包内容已写完） 。
5） CPU读取接收侧描述符以确定包接收完毕。
（其中， 1） 和5） 是CPU读写LLC的访存操作； 2） 是PCIe
downstream方向的操作； 而3） 和4） 是PCIe upstream方向的操作。 ）
6） CPU读取包内容做转发判断。
7） CPU填充更改包内容， 做发送准备。
（6） 和7） 属于转发操作， 并不是收发的必要操作， 都只是CPU的
访存操作， 不涉及PCIe。 ）
发送方向：
8） CPU读发送侧描述符， 检查是否有发送完成标志。
9） CPU将准备发送的缓冲区地址填充到发送侧描述符。
10） 网卡读取发送侧描述符中地址。
11） 网卡根据描述符中地址， 读取缓冲区中数据内容。
12） 网卡写发送侧描述符， 更新发送已完成标记。


# Mbuf与Mempool


为了高效访问数据， DPDK将内存封装在Mbuf（struct rte_mbuf） 结
构体内。 Mbuf主要用来封装网络帧缓存， 也可用来封装通用控制信息
缓存（缓存类型需使用CTRL_MBUF_FLAG来指定） 。

 现在Mbuf头部已经调整成两个Cache Line， 


 为保持包处理的效率， DPDK采用了前者。 网络帧元数据的一部分
内容由DPDK的网卡驱动写入。 






